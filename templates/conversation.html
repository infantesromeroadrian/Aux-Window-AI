<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Transcription</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .chat-container {
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            max-width: 80%;
        }
        
        .message-agent {
            background-color: #e9ecef;
            margin-right: auto;
        }
        
        .message-client {
            background-color: #d1e7ff;
            margin-left: auto;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .dictation-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dictation-button:hover {
            background-color: #c82333;
        }
        
        .dictation-button.active {
            animation: pulse 1.5s infinite;
            background-color: #28a745;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        .dictation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dictation-status {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .message-interim {
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row mb-3">
            <div class="col">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Conversations
                </a>
            </div>
            <div class="col text-center">
                <h2>Conversation Transcript</h2>
            </div>
            <div class="col text-end">
                <button id="clearBtn" class="btn btn-outline-danger me-2">
                    <i class="bi bi-trash"></i> Clear
                </button>
                <button id="exportBtn" class="btn btn-outline-success">
                    <i class="bi bi-download"></i> Export Transcript
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Conversation ID: {{ conversation_id }}</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="liveUpdates" checked>
                        <label class="form-check-label" for="liveUpdates">Live Updates</label>
                    </div>
                </div>
            </div>
            <div class="card-body chat-container" id="chatContainer">
                {% if conversation and conversation.messages %}
                    {% for message in conversation.messages %}
                        <div class="message {% if message.sender == 'agent' %}message-agent{% else %}message-client{% endif %}">
                            <div class="message-sender">{{ message.sender | title }}</div>
                            <div class="message-content">{{ message.content }}</div>
                            <div class="message-timestamp">{{ message.timestamp }}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        No messages in this conversation yet. Start typing or dictating below.
                    </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="row g-2">
                    <div class="col-md-6">
                        <form id="messageForm" class="d-flex">
                            <div class="form-group me-2 flex-grow-1">
                                <label for="senderType" class="visually-hidden">Sender Type</label>
                                <select class="form-select" id="senderType" aria-label="Select sender type">
                                    <option value="agent">Agent</option>
                                    <option value="client">Client</option>
                                </select>
                            </div>
                            <div class="form-group me-2 flex-grow-1">
                                <input type="text" class="form-control" id="messageContent" placeholder="Type your message...">
                            </div>
                            <button type="submit" class="btn btn-primary">Send</button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="dictation-controls">
                            <button id="dictationButton" class="dictation-button" aria-label="Start dictation" title="Start dictation">
                                <i class="bi bi-mic-fill"></i>
                            </button>
                            <div class="dictation-status" id="dictationStatus">Click to start dictation</div>
                            <div class="form-group ms-auto">
                                <select class="form-select" id="dictationLanguage" aria-label="Select language">
                                    <option value="es-ES" selected>Español (España)</option>
                                    <option value="es-419">Español (Latinoamérica)</option>
                                    <option value="en-US">English (US)</option>
                                    <option value="fr-FR">Français</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const conversationId = "{{ conversation_id }}";
            const socket = io();
            const chatContainer = document.getElementById('chatContainer');
            const messageForm = document.getElementById('messageForm');
            const senderType = document.getElementById('senderType');
            const messageContent = document.getElementById('messageContent');
            const liveUpdates = document.getElementById('liveUpdates');
            const exportBtn = document.getElementById('exportBtn');
            const clearBtn = document.getElementById('clearBtn');
            const dictationButton = document.getElementById('dictationButton');
            const dictationStatus = document.getElementById('dictationStatus');
            const dictationLanguage = document.getElementById('dictationLanguage');
            
            let recognition;
            let isListening = false;
            let finalTranscript = '';
            let temporaryMessageElement = null;
            let lastMessageId = null; // Para controlar mensajes duplicados
            let weInitiatedClear = false; // Para saber si fuimos nosotros quienes iniciamos la limpieza
            
            // Configurar el reconocimiento de voz
            function setupSpeechRecognition() {
                // Comprobar si el navegador soporta reconocimiento de voz
                if (!('webkitSpeechRecognition' in window) && 
                    !('SpeechRecognition' in window)) {
                    dictationStatus.textContent = 'Tu navegador no soporta el reconocimiento de voz.';
                    dictationButton.disabled = true;
                    return false;
                }
                
                // Crear el objeto de reconocimiento
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // Configurar el reconocimiento
                recognition.continuous = true;  // Reconocimiento continuo
                recognition.interimResults = true;  // Resultados provisionales
                recognition.lang = dictationLanguage.value;  // Idioma
                
                // Evento cuando se detecta un resultado
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Actualizar el mensaje temporal en la conversación
                    updateTemporaryMessage(finalTranscript, interimTranscript);
                };
                
                // Evento cuando termina el reconocimiento
                recognition.onend = function() {
                    if (isListening) {
                        recognition.start();  // Reiniciar si todavía estamos escuchando
                    } else {
                        dictationButton.classList.remove('active');
                        dictationStatus.textContent = 'Haz clic para iniciar el dictado';
                        
                        // Finalizar el mensaje si hay contenido
                        if (finalTranscript.trim()) {
                            finalizeTemporaryMessage(finalTranscript.trim());
                            finalTranscript = '';
                        } else {
                            // Si no hay contenido, eliminar el mensaje temporal
                            if (temporaryMessageElement) {
                                temporaryMessageElement.remove();
                                temporaryMessageElement = null;
                            }
                        }
                    }
                };
                
                // Evento en caso de error
                recognition.onerror = function(event) {
                    console.error('Error en el reconocimiento de voz:', event.error);
                    dictationStatus.textContent = 'Error: ' + event.error;
                    isListening = false;
                    dictationButton.classList.remove('active');
                };
                
                return true;
            }
            
            // Crear un mensaje temporal en la conversación
            function createTemporaryMessage() {
                const sender = senderType.value;
                
                // Si ya hay un mensaje temporal existente, lo eliminamos primero
                if (temporaryMessageElement) {
                    temporaryMessageElement.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender === 'agent' ? 'message-agent' : 'message-client'}`;
                messageDiv.id = 'temporary-message';
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = sender.charAt(0).toUpperCase() + sender.slice(1);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'message-timestamp';
                timestampDiv.textContent = new Date().toISOString();
                
                messageDiv.appendChild(senderDiv);
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(timestampDiv);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                return messageDiv;
            }
            
            // Actualizar el mensaje temporal con el texto dictado
            function updateTemporaryMessage(finalText, interimText) {
                if (!temporaryMessageElement) {
                    temporaryMessageElement = createTemporaryMessage();
                }
                
                const contentDiv = temporaryMessageElement.querySelector('.message-content');
                if (contentDiv) {
                    contentDiv.innerHTML = finalText + 
                                        '<span class="message-interim">' + 
                                        interimText + 
                                        '</span>';
                
                    // Hacer scroll automático
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // Finalizar el mensaje temporal y enviarlo al servidor
            function finalizeTemporaryMessage(text) {
                if (temporaryMessageElement) {
                    // Si el texto está vacío, simplemente eliminamos el mensaje temporal
                    if (!text.trim()) {
                        temporaryMessageElement.remove();
                        temporaryMessageElement = null;
                        return;
                    }
                    
                    // Actualizar el contenido final
                    const contentDiv = temporaryMessageElement.querySelector('.message-content');
                    if (contentDiv) {
                        contentDiv.textContent = text;
                    }
                    
                    // Generar un ID único para este mensaje
                    const messageId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                    lastMessageId = messageId;
                    
                    // Agregar un atributo data para identificar este mensaje
                    temporaryMessageElement.dataset.clientMessageId = messageId;
                    
                    // Enviar el mensaje al servidor
                    socket.emit('send_message', {
                        conversation_id: conversationId,
                        sender: senderType.value,
                        content: text,
                        client_message_id: messageId
                    });
                    
                    // Limpiar la referencia al mensaje temporal pero mantenemos el mensaje en la UI
                    temporaryMessageElement = null;
                }
            }
            
            // Iniciar/detener dictado
            dictationButton.addEventListener('click', function() {
                if (!recognition && !setupSpeechRecognition()) {
                    return;
                }
                
                if (isListening) {
                    // Detener el dictado
                    isListening = false;
                    recognition.stop();
                    dictationButton.classList.remove('active');
                    dictationStatus.textContent = 'Procesando...';
                } else {
                    // Iniciar el dictado
                    isListening = true;
                    finalTranscript = '';
                    recognition.lang = dictationLanguage.value;  // Actualizar idioma
                    recognition.start();
                    dictationButton.classList.add('active');
                    dictationStatus.textContent = 'Dictando... (haz clic para detener)';
                }
            });
            
            // Cambiar de idioma
            dictationLanguage.addEventListener('change', function() {
                if (recognition) {
                    recognition.lang = dictationLanguage.value;
                    if (isListening) {
                        recognition.stop();
                        recognition.start();
                    }
                }
            });
            
            // Join the conversation room
            socket.emit('join', { conversation_id: conversationId });
            
            // Handle new messages
            socket.on('new_message', function(message) {
                if (!liveUpdates.checked) return;
                
                // Evitar duplicar mensajes que ya hemos creado localmente
                if (message.client_message_id) {
                    // Buscar si ya existe un mensaje con ese ID
                    const existingMessage = document.querySelector(`.message[data-client-message-id="${message.client_message_id}"]`);
                    if (existingMessage) {
                        // Si ya existe, actualizamos el timestamp por si acaso
                        const timestampDiv = existingMessage.querySelector('.message-timestamp');
                        if (timestampDiv) {
                            timestampDiv.textContent = message.timestamp;
                        }
                        return; // No añadimos el mensaje duplicado
                    }
                }
                
                addMessageToChat(message);
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
            
            // Handle status messages
            socket.on('status', function(data) {
                console.log(data.msg);
            });
            
            // Handle errors
            socket.on('error', function(data) {
                console.error('Error:', data.msg);
                alert('Error: ' + data.msg);
            });
            
            // Handle conversation cleared
            socket.on('conversation_cleared', function(data) {
                if (data.conversation_id === conversationId) {
                    // Solo actualizamos si no fuimos nosotros quienes iniciamos la limpieza
                    if (!weInitiatedClear) {
                        chatContainer.innerHTML = `
                            <div class="alert alert-info">
                                La conversación ha sido limpiada por otro usuario.
                            </div>
                        `;
                    }
                    weInitiatedClear = false;
                }
            });
            
            // Handle form submission
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const sender = senderType.value;
                const content = messageContent.value.trim();
                
                if (!content) return;
                
                // Send the message via WebSocket
                socket.emit('send_message', {
                    conversation_id: conversationId,
                    sender: sender,
                    content: content
                });
                
                // Clear the input
                messageContent.value = '';
            });
            
            // Export transcript
            exportBtn.addEventListener('click', function() {
                const messages = Array.from(chatContainer.querySelectorAll('.message')).map(el => {
                    const sender = el.querySelector('.message-sender').textContent;
                    const content = el.querySelector('.message-content').textContent;
                    const timestamp = el.querySelector('.message-timestamp').textContent;
                    
                    return `[${timestamp}] ${sender}: ${content}`;
                }).join('\n');
                
                const blob = new Blob([messages], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversation-${conversationId}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
            
            // Clear conversation
            clearBtn.addEventListener('click', function() {
                if (confirm('¿Estás seguro de que quieres limpiar toda la conversación?')) {
                    // Marcar que fuimos nosotros quienes iniciamos la limpieza
                    weInitiatedClear = true;
                    
                    // Limpiar la interfaz
                    chatContainer.innerHTML = `
                        <div class="alert alert-info">
                            No messages in this conversation yet. Start typing or dictating below.
                        </div>
                    `;
                    
                    // Detener el dictado si está activo
                    if (isListening) {
                        isListening = false;
                        if (recognition) {
                            recognition.stop();
                        }
                        dictationButton.classList.remove('active');
                        dictationStatus.textContent = 'Click to start dictation';
                    }
                    
                    // Limpiar el mensaje temporal si existe
                    if (temporaryMessageElement) {
                        temporaryMessageElement = null;
                    }
                    
                    // Informar al servidor que se ha limpiado la conversación
                    socket.emit('clear_conversation', {
                        conversation_id: conversationId
                    });
                }
            });
            
            // Function to add a message to the chat
            function addMessageToChat(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender === 'agent' ? 'message-agent' : 'message-client'}`;
                
                // Si el mensaje tiene un ID de cliente, lo guardamos como atributo
                if (message.client_message_id) {
                    messageDiv.dataset.clientMessageId = message.client_message_id;
                }
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = message.sender.charAt(0).toUpperCase() + message.sender.slice(1);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = message.content;
                
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'message-timestamp';
                timestampDiv.textContent = message.timestamp;
                
                messageDiv.appendChild(senderDiv);
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(timestampDiv);
                
                chatContainer.appendChild(messageDiv);
            }
            
            // Configurar reconocimiento de voz al cargar
            setupSpeechRecognition();
            
            // Scroll to bottom initially
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    </script>
</body>
</html> 